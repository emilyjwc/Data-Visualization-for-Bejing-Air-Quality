<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment #3 - Beijing Air Quality</title>
    <!-- Include necessary JavaScript libraries -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.25.0/build/vega.min.js" integrity="sha256-na2uPt+tUPV7GRVpc+/ezQj+lGwljIvOJifkmg8f3as=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.15.0/build/vega-lite.min.js" integrity="sha256-WLAn82Ut4GptY/IJf4K/1i+R8ibAkVLFhBVkOovqCK8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.22.2/build/vega-embed.min.js" integrity="sha256-GfFZ6w7V/y3Ws9eHVsOXZ/F1ZFroThVZraOAx3HAt6s=" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
    <h1>Assignment #3 - Beijing Air Quality</h1>

    <!-- Dropdown for selecting pollutant -->
    <label for="pollutantSelect">Select Pollutant:</label>
    <select id="pollutantSelect">
        <option value="pm25">PM 2.5</option>
        <option value="pm10">PM 10</option>
        <option value="o3">Ozone (O3)</option>
        <option value="no2">Nitrogen Dioxide (NO2)</option>
        <option value="so2">Sulfur Dioxide (SO2)</option>
        <option value="co">Carbon Monoxide (CO)</option>
    </select>

    <!-- Container for visualization -->
    <div id="vis"></div>

    <script>
        // Fetch data from the API
        async function fetchData(apiUrl) {
            const response = await fetch(apiUrl);
            const data = await response.json();
            return data;
        }

        // Update and display the chart
        async function updateChart(apiUrl) {
            const data = await fetchData(apiUrl);

            // Extract relevant data
            const timeSeries = data.data.time.s.map(date => new Date(date));
            const pollutants = data.data.iaqi;
            const timeZone = data.data.time.tz;

            // Select pollutants
            const selectedPollutant = document.getElementById('pollutantSelect').value;
            const values = pollutants[selectedPollutant].v;

            // Create a Vega-Lite specification
            const vegaLiteSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {
                    "values": timeSeries.map((date, index) => ({ date, value: values[index] })),
                },
                "mark": "line",
                "encoding": {
                    "x": { "field": "date", "type": "temporal" },
                    "y": { "field": "value", "type": "quantitative" },
                },
            };

            // Embed the visualization in the div with id 'vis'
            vegaEmbed('vis', vegaLiteSpec);
        }

        // Handle dropdown selection change
        const select = document.getElementById('pollutantSelect');
        select.addEventListener('change', () => {
            const apiUrl = "https://api.waqi.info/feed/beijing/?token=f4edd4abb0847e9970cbb651a257aeef2abf68ef";
            updateChart(apiUrl);
        });

        // Initial chart display
        const initialApiUrl = "https://api.waqi.info/feed/beijing/?token=f4edd4abb0847e9970cbb651a257aeef2abf68ef";
        updateChart(initialApiUrl);
    </script>
</body>

</html>
